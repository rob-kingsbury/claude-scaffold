---
name: autopilot
description: >
  Autonomous task runner that gathers work from multiple sources (GitHub issues,
  HANDOFF.md, roadmap docs, inline TODOs, custom files), synthesizes them into
  a prioritized TASKS.md, then executes them unattended via `claude -p` in a
  background loop. Each task runs in a fresh context window with HANDOFF.md for
  continuity. Use when: "run autopilot", "autopilot", "run tasks unattended",
  "work through my issues", "AFK mode", or any request to batch-execute tasks
  autonomously without user interaction.
---

# Autopilot Skill

Autonomous task execution with multi-source task gathering and session-isolated
`claude -p` loops.

## Overview

1. **Gather** - Pull tasks from configured sources into TASKS.md
2. **Plan** - Prioritize and order tasks by dependency
3. **Run** - Execute one task per `claude -p` session in a background loop
4. **Handoff** - Update HANDOFF.md between sessions for continuity

## Trigger Phrases

- "run autopilot", "autopilot", "start autopilot"
- "work through my tasks/issues"
- "AFK mode", "run unattended"
- "gather tasks and run them"
- "/autopilot" (slash command)

## Safety Warnings

**Autopilot runs code changes without human review.** Before using:

1. **Create a branch** - Never run on main/master (enforced by runner)
2. **Have test coverage** - The runner requires tests to pass before marking tasks complete
3. **Use granular tasks** - One clear deliverable per checkbox
4. **Review afterward** - Check the diff before merging

**Best for:**
- Well-defined, mechanical tasks (bulk refactoring, adding boilerplate)
- Projects with comprehensive test coverage
- Short task lists where review afterward is feasible

**Avoid for:**
- Tasks requiring architectural judgment
- Projects without tests
- Production systems

## Step 1: Gather Tasks

Before running, gather tasks from available sources. Run the gather script:

```bash
python3 .claude/skills/autopilot/scripts/gather_tasks.py \
  --project-dir . \
  --output TASKS.md \
  --config .autopilot.yml
```

If `.autopilot.yml` doesn't exist, create one interactively by asking the user
which sources to enable.

### Source Priority (default)

1. **GitHub Issues** (labeled `autopilot` or `ready`) - highest signal
2. **HANDOFF.md warnings/blockers** - unfinished work from last session
3. **Roadmap docs** (`ROADMAP.md`, `.claude/context.md`) - planned work
4. **Inline TODOs** - `TODO:`, `FIXME:`, `HACK:` in source files
5. **Custom task files** - any markdown file with `- [ ]` checkboxes

### Task Format in TASKS.md

```markdown
# Tasks (Auto-generated by Autopilot)
# Source: gathered from 3 sources on 2026-02-05
# Run: `bash run_tasks.sh` or use /autopilot

## Critical (from GitHub Issues)
- [ ] Fix auth token expiry not refreshing (#42)
- [ ] Database connection pool exhaustion under load (#38)

## High (from HANDOFF.md)
- [ ] Complete migration started in last session (see HANDOFF.md warnings)

## Normal (from ROADMAP.md)
- [ ] Add rate limiting middleware
- [ ] Implement pagination on /api/users endpoint

## Low (from TODOs in source)
- [ ] TODO: refactor duplicated validation in src/auth/register.ts
- [ ] FIXME: race condition in session cleanup
```

## Step 2: Review & Confirm

After gathering, show the user:
- How many tasks were found per source
- The generated TASKS.md content
- Ask: "Launch autopilot? You can walk away after this." (or skip if `--yes` flag)

If the user wants to edit the task list, let them. The format just needs
`- [ ]` lines.

## Step 3: Ensure HANDOFF.md

If HANDOFF.md doesn't exist, create it with this structure:

```markdown
# Autopilot Handoff

## Last Completed
- (none yet)

## Key Decisions
- (none yet)

## Warnings
- (none yet)

## Current State
- Autopilot initialized

## Do Not Change
- (populated from .autopilot.yml invariants or CLAUDE.md)
```

Populate "Do Not Change" from the project's CLAUDE.md tech stack decisions
or `.autopilot.yml` invariants if available.

## Step 4: Launch

```bash
chmod +x .claude/skills/autopilot/scripts/run_tasks.sh
mkdir -p .autopilot-logs
nohup bash .claude/skills/autopilot/scripts/run_tasks.sh > .autopilot-logs/nohup_output.log 2>&1 &
echo "Autopilot launched - PID stored in .autopilot-logs/autopilot.pid"
```

Tell the user:
- The PID (from `.autopilot-logs/autopilot.pid`)
- How to check progress: `cat HANDOFF.md` or `tail -f .autopilot-logs/run_*.log`
- How to stop: `kill $(cat .autopilot-logs/autopilot.pid)`
- How to pause gracefully: `touch .autopilot-pause` (resumes when removed)
- That the lockfile prevents accidental double-runs
- That they can walk away now

## Monitoring Commands

When the user asks "autopilot status" or "how's autopilot doing":

```bash
# Tasks remaining
echo "Remaining: $(grep -c '^\s*- \[ \]' TASKS.md) | Done: $(grep -c '^\s*- \[x\]' TASKS.md)"

# Last activity
tail -5 .autopilot-logs/run_*.log

# Current handoff state
cat HANDOFF.md

# Check if paused
[ -f .autopilot-pause ] && echo "PAUSED (remove .autopilot-pause to resume)"
```

## Stopping & Resuming

**Pause:** `touch .autopilot-pause` (stops after current task completes)

**Stop:** `kill $(cat .autopilot-logs/autopilot.pid 2>/dev/null || pgrep -f run_tasks.sh)`

**Resume:** Re-run step 4. The runner reads TASKS.md fresh each iteration -
completed tasks stay checked off.

**Rollback:** Each task creates a git tag `autopilot-checkpoint-{n}`. To rollback:
```bash
git log --oneline --tags | grep autopilot-checkpoint
git reset --hard autopilot-checkpoint-5  # Rollback to before task 6
```

**Re-gather:** Run step 1 again to pull in new issues/TODOs that appeared
while autopilot was running. Existing completed tasks are preserved.

## Configuration: .autopilot.yml

```yaml
sources:
  github_issues:
    enabled: true
    labels: ["autopilot", "ready", "good first issue"]
    exclude_labels: ["blocked", "wontfix"]
    max: 20
  handoff:
    enabled: true
  roadmap:
    enabled: true
    files: ["ROADMAP.md", ".claude/context.md"]
  todos:
    enabled: true
    paths: ["src/", "lib/"]
    exclude: ["node_modules/", "vendor/", ".git/"]
  custom:
    enabled: false
    files: []

runner:
  max_iterations: 50
  cooldown_seconds: 5
  max_retries: 2
  auto_commit: true
  require_tests: true           # Run tests before marking complete
  test_command: "npm test"      # Or "pytest", "php artisan test", etc.
  session_timeout: 600          # 10 min per task (prevents hangs)
  max_log_files: 100            # Auto-rotates old session logs
  max_changed_files: 20         # Pause if more files changed
  protected_branches: ["main", "master", "production"]

invariants:
  - "TypeScript strict mode"
  - "Use existing database schema - do not alter migrations"

priority_order:
  - github_issues
  - handoff
  - roadmap
  - todos
  - custom
```

## Important Notes

- Each `claude -p` session gets a **fresh context window** - no degradation
- The runner requires `claude` CLI (`npm install -g @anthropic-ai/claude-code`)
- Tasks should be granular - one clear deliverable per checkbox
- The "Do Not Change" section in HANDOFF.md prevents architectural drift
- `.autopilot-logs/` should be in `.gitignore`
- **Branch protection**: Runner refuses to run on main/master
- **Test requirement**: Tasks only marked complete if tests pass (when configured)
- **Checkpoints**: Git tags created before each task for easy rollback
- **Pause file**: Touch `.autopilot-pause` for graceful stop between tasks
